## プロダクト概要

『お天気かあさん』は、毎朝の天気予報を「お母さん」のような口調でユーザーに伝えるモバイルアプリです。ハッカソンの提出物として、必要最小限の機能を盛り込んだMVPとして高速に構築します。

## 用語定義
- 「お天気かあさん」：アプリ日本語表示名
- 「weathermother」：ローカル開発時に使用するプロジェクト名
- 「お母さん天気情報」：APIで取得した天気予報情報をLLMで「まるでお母さんが言っているようなセリフ」に変換されたもの
- 

## 実装済みの部分
現在、すでに「バックエンド」部分は完璧に実装が完了しています。
なので今回は、フロントエンド部分、モバイルアプリ部分の開発に注力します。

## 技術概要
### バックエンド
バックエンドでは、以下の処理をバッチで毎日6時に行います。
「天気予報APIから取得した天気情報をGeminiに渡して、お母さん言葉に変換したものをfirestoreに保存」
### フロントエンド
フロントエンドでは、LLMとの通信などは一切行わず、バックエンドで処理されfirestoreに格納された「お母さん天気情報」を表示するシンプルな機能にします。
具体的には、Firestoreのweather_dataコレクション中の、「generatedMessage」を「お母さん天気情報」として表示します。
#### 技術選定
##### バックエンド
- **Cloud Functions:** 天気予報APIから天気情報の取得、「お母さん天気情報」の生成、firestoreへの保存。
- **Vertex AI Studio (Gemini API):** 天気予報データを「おかあさんがいった」風のメッセージ（「お母さん天気情報」）に変換。
- **Cloud Scheduler:** Cloud Functions を定期的に実行するためのスケジューリングサービス。
- **Firestore:** NoSQL データベース。ユーザー情報（都道府県、プッシュ通知希望時間）、「お母さん天気情報」を保存します。
##### フロントエンド
- Expo（ReactNative）

## 開発フロー
1. 環境構築
2. 簡易的な画面設計
3. Firebase Authによる匿名ユーザー認証機能実装
4. UIの作成と基本的な画面遷移の実装
5. ユーザーが都道府県を設定して、設定内容を保存する
6. Firestoreのデータを参照して表示する
7. プッシュ通知機能の実装
8. デバッグ
9. リリース準備


## 機能概要(フロントエンド)
### 「お母さん天気情報」表示機能
ユーザーがあらかじめ選択した都道府県と対応する「お母さん天気情報」を **毎日6時以降にアクセスした際に** Firestoreから取得して表示する。
### ユーザー認証機能
・Firebase Authentication を使用して匿名認証を実装。
・ユーザーはアプリ起動時に自動的に匿名ユーザーとしてログインする。
### 都道府県設定機能
・初回起動時に、ユーザーに都道府県を選択させる。  
・選択された都道府県は、ユーザー情報として Firestore に保存される。
### プッシュ通知
・毎日指定した時刻（例：7:00）に、ユーザーの都道府県に対応する「お母さん天気情報」メッセージをプッシュ通知で送信する。

## 画面構成
###  スプラッシュスクリーン
アプリのアイコンと名前を表示
### メイン画面
- 「お母さん天気情報」の表示
- おかんのイラスト素材
- ハンバーガーメニューアイコン：明日とサイドメニューが開く。サイドメニューには、利用規約とプライバシーポリシーへのリンク、クレジットの表記（将来的にはアプリ内設定を行えるようにする）
### 初回起動時画面フロー
アプリの説明 → 都道府県選択 → 通知許可説明 → 通知許可
#### 1. 起動画面（スプラッシュスクリーン）
#### 2. アプリの説明画面（初回起動時のみ）
- お天気かあさん」がどんなアプリなのかを簡潔に説明
    - 例: 「毎朝、お母さんが天気予報を教えてくれるアプリです！」
    - おかんのイラストを添える
- 「次へ」ボタン
#### 3. 都道府県選択画面
- タイトル：「お住まいの地域を選択してください」
- 都道府県選択用のUI
- 「はじめる」ボタン
#### 4. 通知許可の説明画面（初回起動時のみ、かつ「はじめる」ボタンの後）
- なぜ通知の許可が必要なのかを説明
	- 例: 「毎朝7時に、お母さんからの天気予報メッセージを受け取るには、通知をオンにしてください。」
- 許可するメリットを強調
	- 例: 「通知をオンにすると、雨の日も傘を忘れない！」
	- 「(将来的に時刻のカスタマイズが可能になったら) あなたの生活リズムに合わせて、好きな時間に通知を受け取れます。」
- **補足説明**: 「この後、通知の許可を求めるダイアログが表示されます。「許可」を選択して、お天気かあさんからのメッセージをお受け取りください。」
- 「次へ」ボタン (ボタンの文言は「許可する」でも良いかもしれません)
#### 5. OSの通知許可ダイアログ
- ユーザーが「次へ」ボタンをタップすると表示される
#### 6.  メイン画面
- 通知が許可された場合は、`expoPushToken` を Firestore に保存。

## 機能詳細
### プッシュ通知
#### 実装方針
Expo Notficationsを使います。
（高速な開発の意図があるので、今回はFirebase Cloud Messagingは使用しません）
#### 通知内容
- **タイトル**：「お天気かあさん」
- **本文**：firestoreから参照した「generatedMessage」データ（ユーザーが選択した地域の今日のデータ）
- **追加データ**：通知をタップするとアプリが開くように
- **アイコン**: アプリアイコンと同じ（`app.json` で設定）
- **サウンド**: デフォルトの通知音を使用（`app.json` で設定）
#### 通知の送信タイミング
- 毎朝 7:00 (日本時間) に一斉に通知を送信。
- (リリース後の実装として「ユーザーが設定した時刻に通知を送る」というものがあるが、MVPの段階では、一律7:00でOK)
#### 通知の送信トリガー
- バックエンド (Cloud Functions) で実装します。
- Cloud Functions で、毎日午前7時に、`users` コレクションから `expoPushToken` と `areaCode` を取得し、`weather_data` コレクションから該当する「お母さん天気情報」を取得して、Expo のサーバーにプッシュ通知を送信する関数を作成します。
#### プッシュ通知の許可取得タイミング
- 初期設定画面で、ユーザーが「はじめる」ボタンをタップ
- OSのプッシュ通知許可ダイアログを表示
- ユーザーが「許可」を選択した場合：
    - `expo-notifications` を使用してプッシュ通知トークンを取得
    - 取得したトークンをユーザー情報 (`users` コレクション) に `expoPushToken` として保存
    - メイン画面へ遷移
- ユーザーが「許可しない」を選択した場合：
    - プッシュ通知トークンは保存しない
    - メイン画面へ遷移
    - (注記) プッシュ通知が主要機能であるため、ユーザーが通知を拒否した場合のアプリの利用への影響について、別途検討が必要。
#### プッシュ通知の設定
メイン画面にあるハンバーガーメニューからプッシュ通知の設定画面に遷移。
そこでスイッチをON / OFF することで通知のオンオフを切り替えられる。
（リリース後の実装として「ユーザーが設定した時刻に通知を送る」を行う際には、この通知設定画面で、希望のプッシュ通知時間を選択させる。）
#### エラーケースの対応
##### プッシュ通知トークンの取得に失敗した場合の対応方針
- **エラーログを出力**: `getExpoPushTokenAsync()` がエラーを返した場合は、エラー内容をログに出力し、原因を調査できるようにします。
- **ユーザーへの通知**: アラートなどで、ユーザーにエラーが発生した旨を通知します。例：「プッシュ通知トークンの取得に失敗しました。通知を受け取るには、アプリを再起動して、再度お試しください。」
- **機能制限**: プッシュ通知トークンが取得できない状態でも、アプリは基本的な機能（天気情報の表示など）を利用できるようにします。

##### 通知の送信に失敗した場合のリトライ方針
- **Cloud Functions 側でリトライ処理を実装**: 一時的なネットワークエラーなどで送信に失敗した場合は、一定時間をおいてリトライします。
    - `expo-server-sdk` にリトライ機能があるため、そちらを使うのが良いでしょう
- **リトライ回数制限**: 無限にリトライし続けると、サーバーに負荷がかかるため、最大リトライ回数を設定します。
- **エラーログ**: リトライに失敗した場合は、エラー内容をログに出力します。

##### デバイスがオフラインの場合の対応方針
- **Expo Notifications (および FCM/APNs) が、デバイスがオンラインになったときに通知を再送** してくれます。
- ただし、**再送には期限がある** ため、あまりにも長い間オフラインだった場合は、通知が届かない可能性があります。
- 重要な通知の場合は、アプリ起動時にサーバーに問い合わせて、未読の通知がないか確認するなどの対策が必要になる場合があります。しかし、「お天気かあさん」の場合は、そこまで緊急性の高い通知はないと思われるため、**特別な対応は不要** でしょう。
#### そのほか
- 通知を拒否したユーザーへの対応方針：後からアプリ内で通知を有効にできるようにする。設定画面からいつでも変更できるようにします
- 通知を拒否した場合のユーザーへの説明文言
	- 拒否された直後:
	    - 「通知が拒否されました。毎朝の天気予報メッセージを受け取るには、設定アプリから「お天気かあさん」の通知を許可してください。」といったアラートを表示し、設定アプリへの誘導を行う。
	- 設定画面:
	    - 「通知をオンにすると、毎朝7時に、お母さんからの天気予報メッセージを受け取ることができます。」といった説明文を追加し、通知をオンにするメリットを伝える。

## データベース構造
FirestoreをDBとして使用
### 天気情報関連
以下の形でデータが格納済み。
```
weather_data/ // コレクション名
  └── YYYYMMDD-areaCode/ // ドキュメントID（例：20240315-130000）
       ├── areaCode: string      // 地域コード（例：130000）
       ├── weatherForecasts: string  // 気象庁APIからの天気予報データ（JSON文字列）
       ├── generatedMessage: string   // Geminiが生成したお母さんのメッセージ
       └── createdAt: timestamp    // データ作成日時
```
### ユーザー情報関連
以下の形でのデータ格納を想定しています。
```
users/ // コレクション名
  └── ユーザー ID (Firebase Authentication で生成される UID)/ // ドキュメントID
       ├── userId: string      // ユーザー ID (Firebase Authentication で生成される UID)
       ├── areaCode: string  // ユーザーが選択した地域の地域コード (例: 016000)
       ├── expoPushToken: string // Expo プッシュ通知トークン
	  ├── isPushNotificationEnabled　// 通知設定
       ├── preferredPushNotificationTime: string   // ユーザーが設定したプッシュ通知希望時刻 (例: `07:00`) (オプション機能。MVPでは使用しないが、将来のために定義しておく)
       ├── createdAt: timestamp    // ユーザー情報作成日時
	   └── updatedAt: timestamp    // ユーザー情報更新日時
       
```
**サンプルデータ**
```json
{
  "userId": "8hUbIc8IrkTll8yKm3ARblcdWEM2",
  "areaCode": "016000",
  "preferredPushNotificationTime": "07:00",
  "createdAt": "2023-10-27T09:00:00Z"
}
```


## プロンプト
```
あなたに渡したのはたった今取得した特定地域の天気予報情報です。

この天気予報の情報を一般家庭のお母さんが朝のテレビで知ったとします。

その後、家を出かけようとした女子高生の娘に対して、今日の天気に関して話すだろうセリフを、指定するjson形式で出力してください。

  

# セリフ条件

- セリフは一つだけにしてください。

- 必要以上に天気情報を網羅しようとしなくて構いません。その人物が重要だと思って娘に話すだろうセリフを出力してください。

- お母さんは50代の女性です。その地域の方言が強い場合は、方言を軽く取り入れたセリフにしてください。

- 指定したjson形式以外の文字列は出力しないでください。

  

# 出力条件

- 余分な説明や装飾は一切付けず、セリフのみを出力してください。

  

# 出力例:

{

"mother_message": "今日の夜雨が降るかもしれんから、折り畳み傘もっときー。あと、夜寒いかもしれんから上着とか羽織っていきなね。"

}
```

---
# Q&A

### 技術スタックの詳細化が必要な点
#### Expoの開発方式（managed workflowかbare workflowか）が明記されていません
A. managed workflowにします。
#### UIライブラリの選定（NativeBase、React Native Paper等）が未定です
一旦、使用しません
#### 状態管理ライブラリ（Zustand等）の選定が必要です
一旦、使用しません
### Firebase関連の設定詳細
#### Firebase SDKの具体的な設定方法やconfig情報の管理方法が未定です
Firebase 構成オブジェクト ファイルを作成し、`src/config` ディレクトリに配置する

#### Firestoreのセキュリティルールの設定方針が記載されていません
- users コレクション: ユーザーは自分のドキュメントのみ読み書き可能
- wather_data コレクション: 全ユーザーが読み取り可能、書き込みは認証された特定のユーザー・サービスアカウントからのみ許可（Cloud Functionsを想定）
### アプリのバージョニングとデプロイ

#### アプリのバージョン管理方針が未定です
一般的かつベストな方法に任せます

#### EAS（Expo Application Services）の利用方針が明確になっていません
利用します。
### 環境変数の管理

#### 開発環境と本番環境の切り分け方法が未定です
- これはハッカソン用の個人的なプロジェクトですので、全て本番環境で行います。
#### APIキーなどの機密情報の管理方法が記載されていません
一般的かつベストな方法に任せます

### エラーハンドリング
一般的かつベストな方法に任せます
### テスト戦略
これはハッカソン用の個人的なプロジェクトですので、テストを行わず、すべて実際に実行してテストします

---
# Memo
- **`isPushNotificationEnabled` の初期値**: ユーザー情報作成時に、`isPushNotificationEnabled` を `true` (通知オン) で初期化
